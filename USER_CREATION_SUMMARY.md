# ç”¨æˆ·åˆ›å»ºåŠŸèƒ½å®Œå–„æ€»ç»“

## é—®é¢˜æè¿°

1. åŸå§‹çš„ `init_default_users()` å‡½æ•°åªæ˜¯æ‰“å°äº†æ—¥å¿—ä¿¡æ¯ï¼Œä½†æ²¡æœ‰å®é™…å°†é»˜è®¤ç”¨æˆ·æ•°æ®æ’å…¥åˆ°æ•°æ®åº“çš„userè¡¨ä¸­
2. æ•°æ®åº“æ¨¡å‹ä¸­ä½¿ç”¨äº†å¤–é”®çº¦æŸï¼Œä½†ç³»ç»Ÿè¦æ±‚"æ‰€æœ‰æ•°æ®åº“è¡¨éƒ½ä¸èƒ½æœ‰å¤–é”®"
3. SQLAlchemyå…³ç³»æ˜ å°„å› ä¸ºå¤–é”®é—®é¢˜å¯¼è‡´åˆå§‹åŒ–å¤±è´¥

## âœ… è§£å†³æ–¹æ¡ˆ

**æ ¸å¿ƒç­–ç•¥**: å®Œå…¨ç§»é™¤æ‰€æœ‰SQLAlchemyå…³ç³»æ˜ å°„ï¼Œé¿å…å¤–é”®ä¾èµ–é—®é¢˜

## è§£å†³æ–¹æ¡ˆ

### 1. ä¿®æ”¹çš„æ–‡ä»¶

**`backend/scripts/init_system.py`** - ç”¨æˆ·åˆ›å»ºé€»è¾‘
**`backend/shared/database/models/*.py`** - ç§»é™¤æ‰€æœ‰å¤–é”®çº¦æŸå’Œå…³ç³»æ˜ å°„

### 2. åˆ›å»ºçš„å·¥å…·è„šæœ¬

**`backend/scripts/restore_and_fix.py`** - ä»å¤‡ä»½æ¢å¤å¹¶ç§»é™¤å…³ç³»æ˜ å°„
**`backend/scripts/test_user_creation.py`** - éªŒè¯ç”¨æˆ·åˆ›å»ºåŠŸèƒ½
**`backend/scripts/test_user_fix.py`** - æµ‹è¯•ä¿®å¤æ•ˆæœ

#### ä¿®æ”¹å†…å®¹

**A. ç§»é™¤å¤–é”®çº¦æŸ (`backend/shared/database/models/user.py`)**

1. **ç§»é™¤ForeignKeyå¯¼å…¥å’Œä½¿ç”¨**:
   ```python
   # ä¿®æ”¹å‰
   user_id: Mapped[str] = mapped_column(CHAR(36), ForeignKey("users.id"), nullable=False, unique=True)

   # ä¿®æ”¹å
   user_id: Mapped[str] = mapped_column(CHAR(36), nullable=False, unique=True)
   ```

2. **ä½¿ç”¨primaryjoinæ˜ç¡®æŒ‡å®šå…³ç³»è¿æ¥**:
   ```python
   # ä¿®æ”¹å‰
   profile = relationship("UserProfileORM", back_populates="user", uselist=False, cascade="all, delete-orphan")

   # ä¿®æ”¹å
   profile = relationship("UserProfileORM", primaryjoin="UserORM.id == UserProfileORM.user_id", back_populates="user", uselist=False, cascade="all, delete-orphan")
   ```

**B. æ·»åŠ çš„å¯¼å…¥ (`backend/scripts/init_system.py`)**:
```python
import uuid
from passlib.context import CryptContext

# å¯†ç åŠ å¯†ä¸Šä¸‹æ–‡
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
```

#### å®Œå–„çš„ `init_default_users()` å‡½æ•°

æ–°å‡½æ•°å…·å¤‡ä»¥ä¸‹åŠŸèƒ½ï¼š

1. **æ•°æ®åº“è¿æ¥**: ä½¿ç”¨SQLAlchemyå¼‚æ­¥ä¼šè¯è¿æ¥æ•°æ®åº“
2. **ç”¨æˆ·æ£€æŸ¥**: æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤åˆ›å»º
3. **å¯†ç åŠ å¯†**: ä½¿ç”¨bcryptç®—æ³•åŠ å¯†ç”¨æˆ·å¯†ç 
4. **ç”¨æˆ·åˆ›å»º**: åˆ›å»ºå®Œæ•´çš„ç”¨æˆ·ORMå¯¹è±¡å¹¶ä¿å­˜åˆ°æ•°æ®åº“
5. **äº‹åŠ¡ç®¡ç†**: ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
6. **è¯¦ç»†æ—¥å¿—**: æä¾›åˆ›å»ºè¿‡ç¨‹çš„è¯¦ç»†æ—¥å¿—ä¿¡æ¯

### 2. é»˜è®¤ç”¨æˆ·é…ç½®

åˆ›å»ºäº†ä¸¤ä¸ªé»˜è®¤ç”¨æˆ·ï¼š

#### ç®¡ç†å‘˜ç”¨æˆ·
- **ç”¨æˆ·å**: `admin`
- **é‚®ç®±**: `admin@ai-travel.com`
- **å¯†ç **: `admin123456`
- **è§’è‰²**: `admin`
- **æè¿°**: ç³»ç»Ÿç®¡ç†å‘˜

#### æ¼”ç¤ºç”¨æˆ·
- **ç”¨æˆ·å**: `demo_user`
- **é‚®ç®±**: `demo@ai-travel.com`
- **å¯†ç **: `demo123456`
- **è§’è‰²**: `user`
- **æè¿°**: æ¼”ç¤ºç”¨æˆ·

### 3. å®‰å…¨ç‰¹æ€§

1. **å¯†ç å“ˆå¸Œ**: ä½¿ç”¨bcryptç®—æ³•å®‰å…¨å­˜å‚¨å¯†ç 
2. **UUIDç”Ÿæˆ**: ä¸ºæ¯ä¸ªç”¨æˆ·ç”Ÿæˆå”¯ä¸€çš„UUIDä½œä¸ºä¸»é”®
3. **é‡å¤æ£€æŸ¥**: é¿å…åˆ›å»ºé‡å¤çš„ç”¨æˆ·å
4. **éªŒè¯çŠ¶æ€**: é»˜è®¤ç”¨æˆ·è®¾ç½®ä¸ºå·²éªŒè¯å’Œæ¿€æ´»çŠ¶æ€

### 4. æ•°æ®åº“å­—æ®µæ˜ å°„

```python
new_user = UserORM(
    id=user_id,                    # UUIDä¸»é”®
    username=user_data["username"], # ç”¨æˆ·å
    email=user_data["email"],      # é‚®ç®±
    password_hash=password_hash,   # åŠ å¯†åçš„å¯†ç 
    role=UserRole.ADMIN,           # ç”¨æˆ·è§’è‰²
    status="active",               # è´¦æˆ·çŠ¶æ€
    is_verified=True,              # å·²éªŒè¯
    is_active=True,                # å·²æ¿€æ´»
    created_at=datetime.now(),     # åˆ›å»ºæ—¶é—´
    notes=user_data["description"] # å¤‡æ³¨ä¿¡æ¯
)
```

## æµ‹è¯•éªŒè¯

### åˆ›å»ºäº†æµ‹è¯•è„šæœ¬

**`backend/scripts/test_user_creation.py`**

æµ‹è¯•è„šæœ¬åŠŸèƒ½ï¼š
1. æŸ¥è¯¢æ•°æ®åº“ä¸­çš„æ‰€æœ‰ç”¨æˆ·
2. æ˜¾ç¤ºç”¨æˆ·è¯¦ç»†ä¿¡æ¯
3. éªŒè¯å¯†ç å“ˆå¸Œæ˜¯å¦æ­£ç¡®
4. æµ‹è¯•å¯†ç éªŒè¯åŠŸèƒ½

### ä½¿ç”¨æ–¹æ³•

1. **è¿è¡Œåˆå§‹åŒ–è„šæœ¬**:
   ```bash
   cd backend
   python scripts/init_system.py
   ```

2. **æµ‹è¯•ç”¨æˆ·åˆ›å»º**:
   ```bash
   cd backend
   python scripts/test_user_creation.py
   ```

## é¢„æœŸè¾“å‡º

### åˆå§‹åŒ–æ—¶çš„æ—¥å¿—
```
ğŸ‘¤ åˆå§‹åŒ–é»˜è®¤ç”¨æˆ·...
âœ… åˆ›å»ºç”¨æˆ·: admin (admin@ai-travel.com)
âœ… åˆ›å»ºç”¨æˆ·: demo_user (demo@ai-travel.com)
ğŸ‘¥ æˆåŠŸåˆ›å»º 2 ä¸ªé»˜è®¤ç”¨æˆ·
ğŸ” é»˜è®¤ç”¨æˆ·å¯†ç :
  - admin: admin123456
  - demo_user: demo123456
âš ï¸ è¯·åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¿®æ”¹é»˜è®¤å¯†ç ï¼
âœ… é»˜è®¤ç”¨æˆ·åˆå§‹åŒ–å®Œæˆ
```

### æµ‹è¯•è„šæœ¬è¾“å‡º
```
ğŸ§ª æµ‹è¯•ç”¨æˆ·åˆ›å»ºåŠŸèƒ½...

ğŸ“Š æ•°æ®åº“ä¸­å…±æœ‰ 2 ä¸ªç”¨æˆ·:
  ğŸ‘¤ ç”¨æˆ·: admin
     ğŸ“§ é‚®ç®±: admin@ai-travel.com
     ğŸ”‘ è§’è‰²: admin
     âœ… çŠ¶æ€: active
     ğŸ” å·²éªŒè¯: True
     ğŸ“… åˆ›å»ºæ—¶é—´: 2024-01-01 12:00:00
     ğŸ“ å¤‡æ³¨: ç³»ç»Ÿç®¡ç†å‘˜

  ğŸ‘¤ ç”¨æˆ·: demo_user
     ğŸ“§ é‚®ç®±: demo@ai-travel.com
     ğŸ”‘ è§’è‰²: user
     âœ… çŠ¶æ€: active
     ğŸ” å·²éªŒè¯: True
     ğŸ“… åˆ›å»ºæ—¶é—´: 2024-01-01 12:00:00
     ğŸ“ å¤‡æ³¨: æ¼”ç¤ºç”¨æˆ·

ğŸ” æµ‹è¯•å¯†ç éªŒè¯:
  âœ… adminç”¨æˆ·å¯†ç  'admin123456' éªŒè¯: é€šè¿‡
  âŒ adminç”¨æˆ·å¯†ç  'wrongpassword' éªŒè¯: å¤±è´¥
  âœ… demo_userç”¨æˆ·å¯†ç  'demo123456' éªŒè¯: é€šè¿‡

âœ… ç”¨æˆ·åˆ›å»ºåŠŸèƒ½æµ‹è¯•å®Œæˆ
```

## å®‰å…¨æ³¨æ„äº‹é¡¹

1. **ç”Ÿäº§ç¯å¢ƒå¯†ç **: é»˜è®¤å¯†ç ä»…ç”¨äºå¼€å‘å’Œæµ‹è¯•ï¼Œç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹
2. **å¯†ç å¼ºåº¦**: å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨æ›´å¼ºçš„å¯†ç ç­–ç•¥
3. **æƒé™ç®¡ç†**: ç®¡ç†å‘˜è´¦æˆ·åº”è¯¥è°¨æ…ä½¿ç”¨ï¼Œé¿å…æ—¥å¸¸æ“ä½œ
4. **å®šæœŸæ›´æ–°**: å»ºè®®å®šæœŸæ›´æ–°ç”¨æˆ·å¯†ç 

## ç›¸å…³æ–‡ä»¶

- `backend/scripts/init_system.py` - ç³»ç»Ÿåˆå§‹åŒ–è„šæœ¬ï¼ˆå·²ä¿®æ”¹ï¼‰
- `backend/scripts/test_user_creation.py` - ç”¨æˆ·åˆ›å»ºæµ‹è¯•è„šæœ¬ï¼ˆæ–°å¢ï¼‰
- `backend/shared/database/models/user.py` - ç”¨æˆ·ORMæ¨¡å‹
- `backend/shared/models/user.py` - ç”¨æˆ·æ•°æ®æ¨¡å‹

## âœ… é—®é¢˜è§£å†³çŠ¶æ€

**ä¸»è¦é—®é¢˜**: `init_default_users()` å‡½æ•°åªè®°å½•æ—¥å¿—ä½†ä¸åˆ›å»ºç”¨æˆ· âœ… **å·²è§£å†³**
**å¤–é”®çº¦æŸé—®é¢˜**: SQLAlchemyå…³ç³»æ˜ å°„å¯¼è‡´çš„å¤–é”®ä¾èµ–é”™è¯¯ âœ… **å·²è§£å†³**
**ç”¨æˆ·åˆ›å»ºåŠŸèƒ½**: é»˜è®¤ç”¨æˆ·æ— æ³•æ­£ç¡®æ’å…¥æ•°æ®åº“ âœ… **å·²è§£å†³**

## ğŸ‰ æœ€ç»ˆæˆæœ

1. âœ… **ç”¨æˆ·åˆ›å»ºæˆåŠŸ**: admin å’Œ demo_user å·²æˆåŠŸåˆ›å»º
2. âœ… **å¯†ç éªŒè¯æ­£å¸¸**: bcryptå“ˆå¸Œå’ŒéªŒè¯åŠŸèƒ½æ­£å¸¸å·¥ä½œ
3. âœ… **å¤–é”®é—®é¢˜è§£å†³**: å®Œå…¨ç§»é™¤äº†æ‰€æœ‰SQLAlchemyå…³ç³»æ˜ å°„
4. âœ… **æ•°æ®åº“å…¼å®¹**: ç³»ç»Ÿç°åœ¨å®Œå…¨ç¬¦åˆ"ä¸ä½¿ç”¨å¤–é”®"çš„è¦æ±‚

**å…³é”®æˆå°±**: æˆåŠŸè§£å†³äº†"æ‰€æœ‰æ•°æ®åº“è¡¨éƒ½ä¸èƒ½æœ‰å¤–é”®"çš„çº¦æŸè¦æ±‚ï¼Œé€šè¿‡ç§»é™¤æ‰€æœ‰SQLAlchemyå…³ç³»æ˜ å°„ï¼Œç¡®ä¿ç³»ç»Ÿå¯ä»¥æ­£å¸¸è¿è¡Œè€Œä¸ä¾èµ–æ•°æ®åº“çº§åˆ«çš„å¤–é”®çº¦æŸã€‚

## ä¸‹ä¸€æ­¥

1. âœ… ~~è¿è¡Œåˆå§‹åŒ–è„šæœ¬åˆ›å»ºé»˜è®¤ç”¨æˆ·~~ (å·²å®Œæˆ)
2. âœ… ~~è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯ç”¨æˆ·åˆ›å»º~~ (å·²å®Œæˆ)
3. åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¿®æ”¹é»˜è®¤å¯†ç 
4. æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤šé»˜è®¤ç”¨æˆ·æˆ–è§’è‰²
